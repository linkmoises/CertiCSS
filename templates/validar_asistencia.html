<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Validar Asistencia - {{ evento.nombre }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- favicons -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='assets/favicons/favicon-96x96.png') }}" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='assets/favicons/favicon.svg') }}" />
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='assets/favicons/apple-touch-icon.png') }}" />
    <meta name="apple-mobile-web-app-title" content="CertiCSS" />
    <link rel="manifest" href="{{ url_for('static', filename='assets/favicons/site.webmanifest') }}" />
{% if UMAMI_URL %}
    {{ UMAMI_URL | safe }}
{% endif %}
</head>
<body class="bg-gray-50 dark:bg-neutral-900">

    <!-- ========== MAIN CONTENT ========== -->
    <main id="content">
        <div class="max-w-2xl px-4 py-10 sm:px-6 lg:px-8 lg:py-10 mx-auto">
            
            <!-- Card -->
            <div class="bg-white rounded-xl shadow p-4 sm:p-7 dark:bg-neutral-800">

                <!-- TABLA RESUMEN EVENTOS -->
                <div class="mb-6">
                    <!-- Card -->
                    <div class="flex flex-col">
                        <div class="-m-1.5 overflow-x-auto">
                            <div class="p-1.5 min-w-full inline-block align-middle">
                                <div class="bg-white rounded-xl overflow-hidden">
                                    <!-- Header -->
                                    <div class="flex items-center gap-x-3">
                                        <div class="relative h-32 w-32 shrink-0">
    {% if evento.afiche_750 %}
                                            <img src="{{ url_for('static', filename='uploads/' + evento.afiche_750.split('/')[-1]) }}" alt="{{ evento.nombre }}" class="w-32 h-32 object-cover rounded-lg absolute top-0 start-0">
    {% else %}
                                            <img class="size-full absolute top-0 start-0 object-cover rounded-l-xl" src="{{ url_for('static', filename='assets/afiche-generico.jpg') }}" alt="{{ evento.nombre }}">
    {% endif %}                                        
                                        </div>
                                        
                                        <div class="grow">
                                            <h2 class="block text-xl font-bold mt-2">{{ evento.nombre }}</h2>
                                            <h4 class="block text-sm italic mb-2">{{ evento.unidad_ejecutora }}</h4>
                                            <span class="inline-flex items-center gap-1.5 py-1 px-2 rounded-lg text-xs font-medium bg-gray-100 text-gray-800">
                                                {{ evento.tipo }}
                                            </span>
                                            <span class="inline-flex items-center gap-1.5 py-1 px-2 rounded-lg text-xs font-medium bg-gray-100 text-gray-800">
                                                {{ evento.modalidad }}
                                            </span>
                                        </div>
                                    </div>
                                    <!-- End Header -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Card -->
                </div>
                <!-- End TABLA RESUMEN EVENTOS -->

                <div class="mb-8">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-neutral-200">
                        Validar Asistencia de Participante
                    </h2>
                </div>

                <!-- Mostrar mensajes -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="mb-6">
                    {% for category, message in messages %}
                    <div class="{{ 'bg-red-100 border border-red-200 text-red-800' if category == 'error' else 'bg-green-100 border border-green-200 text-green-800' if category == 'success' else 'bg-yellow-100 border border-yellow-200 text-yellow-800' }} px-4 py-3 rounded-lg text-sm mb-2">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <!-- Formulario de validación -->
                <form action="{{ url_for('validar_asistencia', codigo_evento=evento.codigo) }}" method="post" id="validacionForm">
                    <div class="grid sm:grid-cols-12 gap-2 sm:gap-6">
                        
                        <div class="sm:col-span-3">
                            <label for="cedula" class="inline-block text-sm text-gray-800 mt-2.5 dark:text-neutral-200">
                                Cédula
                            </label>
                        </div>
                        
                        <div class="sm:col-span-9">
                            <input type="text" 
                                   id="cedula" 
                                   name="cedula" 
                                   class="py-2 px-3 pe-11 block w-full border-gray-200 shadow-sm text-sm rounded-lg focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600"
                                   placeholder="8-123-456"
                                   onblur="validarCedula(this)"
                                   required>
                            <small id="cedula-error" class="text-red-500 text-sm hidden">Cédula inválida. Por favor, verifica el formato.</small>
                            
                            <!-- Información del participante -->
                            <div id="participante-info" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                                <h4 class="text-sm font-semibold text-blue-800 mb-2">Información del Participante</h4>
                                <div class="text-sm text-blue-700">
                                    <p><strong>Nombre:</strong> <span id="participante-nombre"></span></p>
                                    <p><strong>Perfil:</strong> <span id="participante-perfil"></span></p>
                                    <p><strong>Región:</strong> <span id="participante-region"></span></p>
                                    <p><strong>Unidad:</strong> <span id="participante-unidad"></span></p>
                                </div>
                                <div id="ya-confirmado" class="mt-2 p-2 bg-yellow-100 border border-yellow-200 rounded text-sm text-yellow-800 hidden">
                                    ⚠️ Este participante ya confirmó su asistencia hoy.
                                </div>
                                <div id="material-ya-entregado" class="mt-2 p-2 bg-blue-100 border border-blue-200 rounded text-sm text-blue-800 hidden">
                                    ℹ️ Este participante ya recibió el material educativo en un día anterior.
                                </div>
                            </div>
                        </div>

                        <div class="sm:col-span-3">
                            <label class="inline-block text-sm text-gray-800 mt-2.5 dark:text-neutral-200">
                                Material Educativo
                            </label>
                        </div>
                        
                        <div class="sm:col-span-9">
                            <div class="flex">
                                <input type="checkbox" 
                                       id="material_entregado" 
                                       name="material_entregado"
                                       class="shrink-0 mt-0.5 border-gray-200 rounded text-blue-600 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:checked:bg-blue-500 dark:checked:border-blue-500 dark:focus:ring-offset-gray-800">
                                <label for="material_entregado" class="text-sm text-gray-500 ms-3 dark:text-neutral-400">
                                    Marcar si se entregó kit de participante
                                </label>
                            </div>
                        </div>

                        <div class="sm:col-span-12">
                            <div class="flex gap-x-2">
                                <button type="submit" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none">
                                    <svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="20,6 9,17 4,12"/>
                                    </svg>
                                    Confirmar Asistencia
                                </button>
                                
                                <a href="{{ url_for('checkin_evento', codigo_evento=evento.codigo) }}" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-700 dark:focus:bg-neutral-700">
                                    Volver a tablero de asistencia controlada
                                </a>
                            </div>
                        </div>

                    </div>
                </form>

                <!-- Instrucciones -->
                <div class="mt-8 pt-6 border-t border-gray-200 dark:border-neutral-700">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-neutral-200 mb-4">
                        Instrucciones
                    </h3>
                    <ul class="text-sm text-gray-600 dark:text-neutral-400 space-y-2">
                        <li class="flex items-start">
                            <svg class="shrink-0 size-4 mt-0.5 me-2 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Ingrese el número de cédula del participante para validar su asistencia.
                        </li>
                        <li class="flex items-start">
                            <svg class="shrink-0 size-4 mt-0.5 me-2 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Solo se pueden validar participantes que estén en la lista preregistrada.
                        </li>
                        <li class="flex items-start">
                            <svg class="shrink-0 size-4 mt-0.5 me-2 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Marque la casilla si entregó material educativo al participante (solo se entrega una vez por evento).
                        </li>
                        <li class="flex items-start">
                            <svg class="shrink-0 size-4 mt-0.5 me-2 text-blue-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            Cada participante solo puede confirmar asistencia una vez por día, pero el material educativo se entrega solo una vez durante todo el evento.
                        </li>
                    </ul>
                </div>

            </div>
            <!-- End Card -->
        </div>
    </main>

    <footer class="mt-auto w-full max-w-[85rem] px-4 sm:px-6 lg:px-8 mx-auto">
        <div class="text-center text-xs text-gray-500 my-8">
            <p>Este evento es potenciado por la plataforma CertiCSS.</p>
        </div>
    </footer>


    <script>
    function validarCedula(input) {
        const cedula = input.value.trim();
        input.value = cedula;
        const errorMessage = document.getElementById('cedula-error');

        const patrones = [
            /^(PE|E|N|\d{1,2}(AV|PI)?)-\d{1,4}-\d{1,6}$|^[A-Z]{2}\d{6,20}$/
        ];

        // Verificar si la cédula cumple con alguno de los patrones
        const esValido = patrones.some(patron => patron.test(cedula));

        if (esValido) {
            input.classList.remove('border-red-500');
            input.classList.add('border-gray-200');
            errorMessage.classList.add('hidden');
        } else {
            input.classList.remove('border-gray-200');
            input.classList.add('border-red-500');
            errorMessage.classList.remove('hidden');
        }
    }

    // Auto-focus en el campo de cédula y limpiar después del envío exitoso
    document.addEventListener('DOMContentLoaded', function() {
        const cedulaInput = document.getElementById('cedula');
        const materialCheckbox = document.getElementById('material_entregado');
        
        cedulaInput.focus();
        
        // Limpiar formulario después de envío exitoso (si hay mensaje de éxito)
        const successMessage = document.querySelector('.bg-green-100');
        if (successMessage) {
            setTimeout(() => {
                cedulaInput.value = '';
                materialCheckbox.checked = false;
                cedulaInput.focus();
            }, 1500); // Esperar 1.5 segundos antes de limpiar
        }
    });

    // Envío rápido con Enter
    document.getElementById('validacionForm').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && e.target.id === 'cedula') {
            e.preventDefault();
            this.submit();
        }
    });

    // Buscar participante cuando se ingresa cédula válida
    let searchTimeout;
    document.getElementById('cedula').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const cedula = this.value.trim();
        const participanteInfo = document.getElementById('participante-info');
        
        // Ocultar información previa
        participanteInfo.classList.add('hidden');
        
        // Si la cédula parece válida, buscar participante
        if (cedula.length >= 9) {
            const patrones = [
                /^(PE|E|N|\d{1,2}(AV|PI)?)-\d{1,4}-\d{1,6}$|^[A-Z]{2}\d{6,20}$/
            ];
            const esValido = patrones.some(patron => patron.test(cedula));
            
            if (esValido) {
                searchTimeout = setTimeout(() => {
                    buscarParticipante(cedula);
                }, 500); // Esperar 0.5 segundos después de dejar de escribir
            }
        }
    });

    async function buscarParticipante(cedula) {
        try {
            const codigoEvento = '{{ evento.codigo }}';
            const response = await fetch(`/api/checkin/${codigoEvento}/buscar/${cedula}`);
            const data = await response.json();
            
            const participanteInfo = document.getElementById('participante-info');
            const yaConfirmado = document.getElementById('ya-confirmado');
            const materialYaEntregado = document.getElementById('material-ya-entregado');
            const materialCheckbox = document.getElementById('material_entregado');
            
            if (data.encontrado) {
                // Mostrar información del participante
                document.getElementById('participante-nombre').textContent = `${data.nombres} ${data.apellidos}`;
                document.getElementById('participante-perfil').textContent = data.perfil;
                document.getElementById('participante-region').textContent = data.region;
                document.getElementById('participante-unidad').textContent = data.unidad;
                
                participanteInfo.classList.remove('hidden');
                
                // Mostrar advertencia si ya fue confirmado hoy
                if (data.ya_confirmado) {
                    yaConfirmado.classList.remove('hidden');
                } else {
                    yaConfirmado.classList.add('hidden');
                }
                
                // Mostrar información y deshabilitar checkbox si ya recibió material
                if (data.material_ya_entregado) {
                    materialYaEntregado.classList.remove('hidden');
                    materialCheckbox.checked = false;
                    materialCheckbox.disabled = true;
                    materialCheckbox.parentElement.style.opacity = '0.5';
                } else {
                    materialYaEntregado.classList.add('hidden');
                    materialCheckbox.disabled = false;
                    materialCheckbox.parentElement.style.opacity = '1';
                }
            } else {
                participanteInfo.classList.add('hidden');
                // Resetear estado del checkbox
                materialCheckbox.disabled = false;
                materialCheckbox.parentElement.style.opacity = '1';
            }
        } catch (error) {
            console.error('Error al buscar participante:', error);
        }
    }
    </script>

</body>
</html>