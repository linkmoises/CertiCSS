{% include 'tablero-header.html' %}

{% include 'tablero-sidebar.html' %}

    <!-- Content -->
    <div class="w-full lg:ps-64">
        <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">

            <!-- TABLA RESUMEN EVENTOS -->
            <div class="max-w-[85rem] px-2 pt-1 mx-auto">
                <!-- Card -->
                <div class="flex flex-col">
                    <div class="-m-1.5 overflow-x-auto">
                        <div class="p-1.5 min-w-full inline-block align-middle">
                            <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                                <!-- Header -->
                                <div class="flex items-center justify-between gap-x-3">
                                    <div class="flex items-center gap-x-3">
                                        <div class="relative h-32 w-32 shrink-0">
                                            <img class="w-32 h-32 object-cover rounded-lg absolute top-0 start-0" src="{{ url_for('static', filename='assets/unidades/default-square.jpg') }}" alt="Evento Nacional" />
                                        </div>

                                        <div class="grow">
                                            <h2 class="block text-3xl font-bold mt-2">Departamento Nacional de Docencia e Investigación</h2>
                                            <h4 class="block italic mb-2">Métricas e Informe Nacional</h4>
                                            <span class="inline-flex items-center gap-1.5 py-1 px-2 rounded-lg text-xs font-medium bg-gray-100 text-gray-800">
                                                Eventos Generales
                                            </span>
                                            <span class="inline-flex items-center gap-1.5 py-1 px-2 rounded-lg text-xs font-medium bg-blue-100 text-blue-800">
                                                Año {{ selected_year or current_year or estadisticas.year }}
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Selector de año -->
                                    <div class="mr-8 flex flex-col items-end gap-2">
                                        <label for="year-selector" class="text-sm font-medium text-gray-700">Seleccionar año:</label>
                                        <select id="year-selector" class="py-2 px-3 pe-9 block border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none" onchange="changeYear(this.value)">
{% for year in years_available|reverse %}
                                            <option value="{{ year }}" {% if year == (selected_year or current_year) %}selected{% endif %}>{{ year }}</option>
{% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <!-- End Header -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Card -->
            </div>
            <!-- End TABLA RESUMEN EVENTOS -->

            <!-- TARJETAS RESUMEN -->
            <div class="max-w-[85rem] px-2 pt-1 mx-auto">
                <!-- Grid -->
                <div class="grid sm:grid-cols-2 lg:grid-cols-6 gap-4 sm:gap-6 mb-6">
                    <!-- Card -->
                    <div class="flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                        <div class="flex items-center gap-x-2">
                            <p class="text-xs uppercase tracking-wide text-gray-500">
                                Eventos totales
                            </p>
                        </div>
                
                        <div class="mt-1 flex items-center gap-x-2">
                            <h3 class="text-xl sm:text-2xl font-medium text-gray-800">
                                {{ estadisticas.total_events if estadisticas else 0 }}
                            </h3>
                        </div>
                    </div>
                </div>
                <!-- End Card -->
            
                    <!-- Card -->
                    <div class="flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                        <div class="flex items-center gap-x-2">
                            <p class="text-xs uppercase tracking-wide text-gray-500">
                                Registros totales
                            </p>
                        </div>
                
                        <div class="mt-1 flex items-center gap-x-2">
                            <h3 class="text-xl sm:text-2xl font-medium text-gray-800">
                                {{ estadisticas.total_registrations if estadisticas else 0 }}
                            </h3>
                        </div>
                    </div>
                </div>
                <!-- End Card -->
            
                <!-- Card -->
                <div class="flex flex-col bg-white border shadow-sm rounded-xl">
                    <div class="p-4 md:p-5">
                        <div class="flex items-center gap-x-2">
                            <p class="text-xs uppercase tracking-wide text-gray-500">
                                Participantes únicos
                            </p>
                        </div>
            
                        <div class="mt-1 flex items-center gap-x-2">
                            <h3 class="text-xl sm:text-2xl font-medium text-gray-800">
                                {{ estadisticas.unique_participants if estadisticas else 0 }}
                            </h3>
                        </div>
                    </div>
                </div>
                <!-- End Card -->
            
                <!-- Card -->
                <div class="flex flex-col bg-white border shadow-sm rounded-xl">
                    <div class="p-4 md:p-5">
                        <div class="flex items-center gap-x-2">
                            <p class="text-xs uppercase tracking-wide text-gray-500">
                                Ponencias totales
                            </p>
                        </div>

                        <div class="mt-1 flex items-center gap-x-2">
                            <h3 class="text-xl sm:text-2xl font-medium text-gray-800">
                                {{ estadisticas.total_presentations if estadisticas else 0 }}
                            </h3>
                        </div>
                    </div>
                </div>
                <!-- End Card -->
            
                <!-- Card -->
                <div class="flex flex-col bg-white border shadow-sm rounded-xl">
                    <div class="p-4 md:p-5">
                        <div class="flex items-center gap-x-2">
                            <p class="text-xs uppercase tracking-wide text-gray-500">
                                Tasa recurrencia
                            </p>
                        </div>

                        <div class="mt-1 flex items-center gap-x-2">
                            <h3 class="text-xl sm:text-2xl font-medium text-gray-800">
                                {{ estadisticas.tasa_recurrencia if estadisticas else 0.0 }}%
                            </h3>
                        </div>
                    </div>
                </div>
                <!-- End Card -->
            
                <!-- Card -->
                <div class="flex flex-col bg-white border shadow-sm rounded-xl">
                    <div class="p-4 md:p-5">
                        <div class="flex items-center gap-x-2">
                            <p class="text-xs uppercase tracking-wide text-gray-500">
                                Año
                            </p>
                        </div>

                        <div class="mt-1 flex items-center gap-x-2">
                            <h3 class="text-xl sm:text-2xl font-medium text-gray-800">
                                {{ selected_year or current_year or estadisticas.year }}
                            </h3>
                        </div>
                    </div>
                </div>
                <!-- End Card -->
                </div>
                <!-- fin grid -->

                <div id="informe-descripcion" class="grid">
                    <div class="flex flex-col bg-white border shadow-sm rounded-xl mb-6">
                        <div class="overflow-x-auto p-4">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Informe Nacional - Eventos Generales</h3>
                            <p class="text-base py-1">
                                <span class="font-semibold">Descripción:</span> 
                                Este informe presenta las métricas y estadísticas nacionales de participación en eventos de educación 
                                médica continua para el año {{ selected_year or current_year or estadisticas.year }}, incluyendo 
                                análisis demográficos, distribución geográfica entre otras evaluaciones. Se excluyen de este registro
                                los datos relacionados con sesiones docentes y eventos que no fueron publicados.
                            </p>
                            <p class="text-base py-1">
                                Durante el año {{ selected_year or current_year or estadisticas.year }} se realizaron {{ estadisticas.total_events if estadisticas else 0 }} eventos 
                                totales. En estos eventos se registraron {{ estadisticas.total_registrations if estadisticas else 0 }}
                                participaciones, de los cuales en los datos registrados {{ estadisticas.unique_participants if estadisticas else 0 }}
                                corresponden a participantes únicos. Se registraron en la plataforma además {{ estadisticas.total_presentations if estadisticas else 0 }}
                                ponencias. Esto da un promedio de {% if estadisticas and estadisticas.total_events > 0 %}{{ "%.1f"|format(estadisticas.total_presentations / estadisticas.total_events) }}{% else %}0.0{% endif %} 
                                ponencias por evento. {% if estadisticas and estadisticas.total_events > 0 %}Existen {{ estadisticas.total_events - estadisticas.eventos_con_ponencias }} 
                                eventos donde no se registraron ponencias{% else %}No se registraron ponencias{% endif %} por parte de los creadores de la actividad.
                                Hay una tasa de recurrencia de {{ estadisticas.tasa_recurrencia if estadisticas else 0.0 }}%, este valor indica la cantidad de participantes que son recurrentes en los eventos.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Grid -->
                <div id="grafico-perfil" class="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
                    <!-- Card que ocupa 3 columnas -->
                    <div class="col-span-1 lg:col-span-3 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                            <h4 class="text-base font-semibold text-gray-800 mb-4">Gráfica No 1. Participantes según perfil profesional</h4>
{% if grafica_perfil %}
                            <img src="{{ grafica_perfil }}" alt="Gráfica de perfil profesional" class="w-full h-auto" />
{% else %}
                            <div class="flex flex-col justify-center items-center h-64 bg-gray-50 rounded-lg">
                                <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p class="text-gray-500 text-center">
                                    No hay datos de perfil profesional disponibles.
                                </p>
                            </div>
{% endif %}
                        </div>
                    </div>

                    <!-- Card que ocupa 1 columna -->
                    <div class="col-span-1 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="overflow-x-auto p-4">
                            <h4 class="text-base font-semibold text-gray-800 mb-2">Sobre la Gráfica No. 1</h4>
                            <p class="text-sm mb-2">
                                Los datos con los que se genera esta gráfica proceden del llenado del formulario de 
                                registro de cada participante al momento de registrarse. No incluye los ponentes,
                                organizadores, coorganizadores ni personal de apoyo.
                            </p>
                            <p class="text-sm mb-2">
                                Esta característica se implementó en abril 2025, por lo que eventos anteriores a 
                                esta fecha mostrarán sus datos agrupados en la categoría otros.
                            </p>
                        </div>                          
                    </div>
                </div>
                <!-- fin grid -->

                <!-- Grid -->
                <div id="grafico-region" class="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
                    <!-- Card que ocupa 3 columnas -->
                    <div class="col-span-1 lg:col-span-3 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                            <h4 class="text-base font-semibold text-gray-800 mb-4">Gráfica No. 2. Participantes según región/provincia de procedencia</h4>
{% if grafica_region %}
                            <img src="{{ grafica_region }}" alt="Gráfica de participantes por región" class="w-full h-auto" />
{% else %}
                            <div class="flex flex-col justify-center items-center h-64 bg-gray-50 rounded-lg">
                                <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <p class="text-gray-500 text-center">
                                    No hay datos de región disponibles.
                                </p>
                            </div>
{% endif %}
                        </div>
                    </div>

                    <!-- Card que ocupa 1 columna -->
                    <div class="col-span-1 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="overflow-x-auto p-4">
                            <h4 class="text-base font-semibold text-gray-800 mb-2">Sobre la Gráfica No. 2</h4>
                            <p class="text-sm mb-2">
                                Los datos con los que se genera esta gráfica proceden del llenado del formulario de 
                                registro de cada participante al momento de registrarse. No incluye los ponentes,
                                organizadores, coorganizadores ni personal de apoyo. 
                            </p>
                            <p class="text-sm mb-2">
                                Esta característica se implementó en enero 2025, por lo que eventos anteriores a 
                                esta fecha mostrarán sus datos agrupados en la categoría otros.
                            </p>
                        </div>                          
                    </div>
                </div>
                <!-- fin grid -->

                <div id="grafico-modalidad" class="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
                    <!-- Card -->
                    <div class="col-span-1 lg:col-span-2 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                            <h4 class="text-base font-semibold text-gray-800 mb-4">Gráfica No. 3. Eventos según modalidad</h4>
{% if grafica_modalidad %}
                            <img src="{{ grafica_modalidad }}" alt="Gráfica de eventos por modalidad" class="w-full h-auto" />
{% else %}
                            <div class="flex justify-center items-center h-64 bg-gray-50 rounded-lg">
                                <p class="text-gray-500">No hay datos disponibles para generar la gráfica.</p>
                            </div>
{% endif %}
                        </div>                          
                    </div>
                    <!-- fin card -->

                    <!-- Card -->
                    <div class="col-span-1 lg:col-span-2 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                            <h4 class="text-base font-semibold text-gray-800 mb-4">Gráfica No. 4. Eventos según categoría</h4>
{% if grafica_categoria %}
                            <img src="{{ grafica_categoria }}" alt="Gráfica de eventos por categoría" class="w-full h-auto" />
{% else %}
                            <div class="flex justify-center items-center h-64 bg-gray-50 rounded-lg">
                                <p class="text-gray-500">No hay datos disponibles para generar la gráfica.</p>
                            </div>
{% endif %}
                        </div>                          
                    </div>
                    <!-- card -->
                </div>

                <!-- Grid -->
                <div id="grafico-mensual" class="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
                    <!-- Card que ocupa 2 columnas -->
                    <div class="col-span-1 lg:col-span-3 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                            <h4 class="text-base font-semibold text-gray-800 mb-4">Gráfico No. 5. Distribución de eventos por mes del año</h4>
{% if grafica_mensual %}
                            <img src="{{ grafica_mensual }}" alt="Gráfica de distribución mensual de eventos" class="w-full h-auto" />
{% else %}
                            <div class="flex justify-center items-center h-64 bg-gray-50 rounded-lg">
                                <p class="text-gray-500">No hay datos disponibles para generar la gráfica.</p>
                            </div>
{% endif %}
                        </div>
                    </div>
                    <!-- fin card -->

                    <div class="col-span-1 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                            <h4 class="text-base font-semibold text-gray-800 mb-4">Sobre las fuentes de datos</h4>
                            <p class="py-2 text-sm text-gray-500">
                                La información presentada en este informe se deriva de los registros de eventos y 
                                participantes almacenados en la plataforma CertiCSS durante el año {{ selected_year or current_year or estadisticas.year }}.
                            </p>
                            <p class="py-2 text-sm text-gray-500">
                                Se excluyen de este análisis los eventos de tipo "Sesión Docente" y aquellos 
                                eventos que se encuentran en estado de borrador, para proporcionar una visión 
                                precisa de las actividades de educación médica continua completadas.
                            </p>
                            <p class="py-2 text-sm text-gray-500">
                                Las gráficas de participantes muestran datos agregados de todos los eventos 
                                válidos del período, mientras que las gráficas de eventos muestran la 
                                distribución por modalidad, categoría y frecuencia temporal.
                            </p>
                        </div>
                    </div>

                </div>
                <!-- fin grid -->

                <!-- Grid para gráfica de eventos por provincia -->
                <div id="grafico-eventos-provincia" class="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
                    <!-- Card que ocupa 3 columnas -->
                    <div class="col-span-1 lg:col-span-3 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                            <h4 class="text-base font-semibold text-gray-800 mb-4">Gráfico No. 6. Distribución de eventos por provincia</h4>
{% if grafica_eventos_provincia %}
                            <img src="{{ grafica_eventos_provincia }}" alt="Gráfica de eventos por provincia" class="w-full h-auto" />
{% else %}
                            <div class="flex justify-center items-center h-64 bg-gray-50 rounded-lg">
                                <p class="text-gray-500">No hay datos disponibles para generar la gráfica.</p>
                            </div>
{% endif %}
                        </div>
                    </div>
                    <!-- fin card -->

                    <!-- Card que ocupa 1 columna -->
                    <div class="col-span-1 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="overflow-x-auto p-4">
                            <h4 class="text-base font-semibold text-gray-800 mb-2">Sobre la Gráfica No. 6</h4>
                            <p class="text-sm mb-2">
                                Esta gráfica muestra la distribución geográfica de los eventos de educación médica 
                                continua realizados durante el año {{ selected_year or current_year or estadisticas.year }}.
                            </p>
                            <p class="text-sm mb-2">
                                Los datos se basan en la región/provincia donde se realizó cada evento, según fue 
                                registrado por los organizadores al momento de crear la actividad en la plataforma.
                            </p>
                            <p class="text-sm mb-2">
                                Se excluyen eventos en estado de borrador y sesiones docentes para mostrar únicamente 
                                las actividades de educación médica continua completadas.
                            </p>
                        </div>                          
                    </div>
                </div>
                <!-- fin grid -->

                <!-- Grid para histograma de horas de registro -->
                <div id="grafico-horas-registro" class="grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6 mb-6">
                    <!-- Card que ocupa 3 columnas -->
                    <div class="col-span-1 lg:col-span-3 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="p-4 md:p-5">
                            <h4 class="text-base font-semibold text-gray-800 mb-4">Gráfico No. 7. Distribución de registros por hora del día</h4>
{% if grafica_horas_registro %}
                            <img src="{{ grafica_horas_registro }}" alt="Histograma de registros por hora" class="w-full h-auto" />
{% else %}
                            <div class="flex justify-center items-center h-64 bg-gray-50 rounded-lg">
                                <p class="text-gray-500">No hay datos disponibles para generar el histograma.</p>
                            </div>
{% endif %}
                        </div>
                    </div>
                    <!-- fin card -->

                    <!-- Card que ocupa 1 columna -->
                    <div class="col-span-1 flex flex-col bg-white border shadow-sm rounded-xl">
                        <div class="overflow-x-auto p-4">
                            <h4 class="text-base font-semibold text-gray-800 mb-2">Sobre el Gráfico No. 7</h4>
                            <p class="text-sm mb-2">
                                Este histograma muestra la distribución de los registros de participantes según 
                                la hora del día en que se registraron durante el año {{ selected_year or current_year or estadisticas.year }}.
                            </p>
                            <p class="text-sm mb-2">
                                Solo se incluyen registros realizados antes de la hora de finalización de cada evento, 
                                excluyendo registros tardíos o posteriores al cierre de la actividad.
                            </p>
                            <p class="text-sm mb-2">
                                Los datos ayudan a identificar patrones de comportamiento de registro y horarios 
                                de mayor actividad en la plataforma.
                            </p>
                        </div>                          
                    </div>
                </div>
                <!-- fin grid -->

            </div>
            <!-- FIN TARJETAS RESUMEN -->

{% include 'tablero-footer.html' %}

        </div>
    </div>
    <!-- End Content -->

<!-- JS PLUGINS -->
<script src="{{ url_for('static', filename='node_modules/preline/dist/preline.js') }}"></script>
<script>
// Función para cambiar el año
function changeYear(selectedYear) {
    // Redirigir a la misma página con el año seleccionado
    window.location.href = `/tablero/metricas/nacional/${selectedYear}`;
}

// Limpia campos dinámicos al cargar la página
document.addEventListener("DOMContentLoaded", function () {
    const hiddenInputs = document.querySelectorAll("#buscadorForm input[type='hidden']");
    hiddenInputs.forEach((input) => input.remove());
});
document.getElementById("buscadorForm").addEventListener("submit", function (event) {
    event.preventDefault(); // Prevenir envío estándar del formulario

    const valor = document.getElementById("buscador").value.trim();
    const patterns = {
        cedula: /^(PE|E|N|\d{1,2}(AV|PI)?)-\d{1,4}-\d{1,6}$/, // Cédulas panameñas
        pasaporte: /^[A-Z]{2}\d{6,9}$/,                        // Pasaportes
        id_certificado: /^[a-zA-Z0-9]{8}$/                    // IDs de certificados
    };

    let action, field;

    if (patterns.cedula.test(valor)) {
        action = "/buscar_certificados";
        field = "cedula";
    } else if (patterns.pasaporte.test(valor)) {
        action = "/buscar_certificados";
        field = "cedula";
    } else if (patterns.id_certificado.test(valor)) {
        action = "/validar_certificado";
        field = "nanoid";
    } else {
        alert("Formato no válido. Introduzca un documento de identificación o un ID de certificado válido.");
        return;
    }

    // Crear y enviar el formulario dinámicamente
    const form = event.target;
    form.action = action;
    form.method = "POST";

    // Limpiar campos ocultos previos
    const hiddenInputs = form.querySelectorAll("input[type='hidden']");
    hiddenInputs.forEach((input) => input.remove());

    const hiddenInput = document.createElement("input");
    hiddenInput.type = "hidden";
    hiddenInput.name = field;
    hiddenInput.value = valor;
    form.appendChild(hiddenInput);
    form.submit();
});
</script>
</body>
</html>