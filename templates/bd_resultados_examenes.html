{% include 'tablero-header.html' %}

{% include 'tablero-sidebar.html' %}
    
    <!-- CONTENIDO -->
    <div class="w-full lg:ps-64">
        <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
            
            <!-- TABLA RESUMEN RESULTADOS -->
            <div class="max-w-[85rem] px-2 pt-1 mx-auto">
                <!-- Card -->
                <div class="flex flex-col">
                <div class="-m-1.5 overflow-x-auto">
                    <div class="p-1.5 min-w-full inline-block align-middle">
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">

                        <!-- Header -->
                        <div class="px-6 py-4 grid gap-3 md:flex md:justify-between md:items-center border-b border-gray-200">
                            <div>
                                <h2 class="text-xl font-semibold text-gray-800">
                                    MongoDB - Colección - Resultados de Exámenes
                                </h2>
                                <p class="text-sm text-gray-600">
                                    Vista de edición de campos de los resultados de exámenes
                                </p>
                            </div>
            
                            <div>
                                <div class="inline-flex gap-x-2">
                                    <a class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50" href="{{ url_for('db_eventos') }}">
                                        <svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                                        Eventos
                                    </a>
                                    <a class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50" href="{{ url_for('db_evaluaciones') }}">
                                        <svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
                                        Evaluaciones
                                    </a>
                                </div>
                            </div>
                        </div>
                        <!-- End Header -->

        {% if resultados|length == 0 %}
                        
                        <!-- Body -->
                        <div class="max-w-sm w-full min-h-[400px] flex flex-col justify-center mx-auto px-6 py-4">
                            <div class="flex justify-center items-center size-[46px] bg-gray-100 rounded-lg dark:bg-neutral-800">
                                <svg class="shrink-0 size-6 text-gray-600 dark:text-neutral-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4"/><path d="M21 12c.552 0 1-.448 1-1V5c0-.552-.448-1-1-1H3c-.552 0-1 .448-1 1v6c0 .552.448 1 1 1"/><path d="M3 10h18"/></svg>
                            </div>

                            <h2 class="mt-5 font-semibold text-gray-800 dark:text-white">
                                No hay resultados
                            </h2>
                            <p class="mt-2 text-sm text-gray-600 dark:text-neutral-400">
                                No se encontraron resultados de exámenes en la base de datos.
                            </p>
                        </div>
                        <!-- End Body -->

        {% else %}

                        <!-- Table -->
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    {% for campo in campos %}
                                    <th scope="col" class="px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase">{{ campo }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>

                            <tbody class="divide-y divide-gray-200">
                                {% for resultado in resultados %}
                                <tr>
                                    {% for campo in campos %}
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">
                                        {% if campo == '_id' %}
                                            {{ resultado.get(campo, '') }}
                                        {% elif campo == 'calificacion' %}
                                            <span class="inline-flex items-center gap-1.5 py-1 px-2 rounded-lg text-xs font-medium 
                                            {% if resultado.get(campo, 0) >= 80 %}bg-green-100 text-green-800
                                            {% elif resultado.get(campo, 0) >= 60 %}bg-yellow-100 text-yellow-800
                                            {% else %}bg-red-100 text-red-800
                                            {% endif %}">
                                                {{ resultado.get(campo, 0) }}%
                                            </span>
                                        {% elif campo == 'fecha_envio' and resultado.get(campo) %}
                                            {{ resultado.get(campo).strftime('%Y-%m-%d %H:%M') if resultado.get(campo) else '' }}
                                        {% elif campo == 'respuestas' and resultado.get(campo) %}
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{{ resultado.get(campo)|length }} respuestas</span>
                                        {% else %}
                                            <input type="text" 
                                                   class="campo-editable w-full px-2 py-1 text-sm border border-gray-200 rounded focus:border-blue-500 focus:outline-none" 
                                                   value="{{ resultado.get(campo, '') }}" 
                                                   data-resultado-id="{{ resultado._id }}" 
                                                   data-campo="{{ campo }}"
                                                   {% if campo == '_id' %}readonly{% endif %}>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <!-- End Table -->

                        <!-- Footer -->
                        <div class="px-6 py-4 grid gap-3 md:flex md:justify-between md:items-center border-t border-gray-200">
                            <div>
                                <p class="text-sm text-gray-600">
                                    <span class="font-semibold text-gray-800">{{ total_resultados }}</span> resultados de exámenes
                                </p>
                            </div>

                            <div>
                                <div class="inline-flex gap-x-2">
                                    {% if page > 1 %}
                                    <a href="{{ url_for('db_resultados_examenes', page=page-1) }}" class="py-1.5 px-2 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50">
                                        <svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                                        Anterior
                                    </a>
                                    {% endif %}

                                    {% if page < total_paginas %}
                                    <a href="{{ url_for('db_resultados_examenes', page=page+1) }}" class="py-1.5 px-2 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50">
                                        Siguiente
                                        <svg class="shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- End Footer -->

        {% endif %}

                    </div>
                </div>
                </div>
                <!-- End Card -->
            </div>
            <!-- End Table Section -->

        </div>
    </div>

{% include 'tablero-footer.html' %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Agregar event listeners a todos los campos editables
    document.querySelectorAll('.campo-editable').forEach(function(input) {
        input.addEventListener('blur', function() {
            const resultadoId = this.dataset.resultadoId;
            const campo = this.dataset.campo;
            const valor = this.value;
            
            // Enviar actualización al servidor
            fetch('/actualizar_campo_resultado_examen', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    resultado_id: resultadoId,
                    campo: campo,
                    valor: valor
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cambiar temporalmente el color de fondo para indicar éxito
                    this.style.backgroundColor = '#d1fae5';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 1000);
                } else {
                    // Mostrar error
                    alert('Error al actualizar: ' + data.error);
                    this.style.backgroundColor = '#fee2e2';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error de conexión');
            });
        });
    });
});
</script>